<link rel="stylesheet" href="/data/html/js/vendor/leafletjs/1.3.1/leaflet.css" crossorigin=""/>

<script src="/data/html/js/vendor/leafletjs/1.3.1/leaflet.js" crossorigin=""></script>

<div id="mapid" style="height:100%;width:100%;"></div>
<script type="text/javascript">
  L.Map = L.Map.extend({
    openPopup: function(popup) {
      //        this.closePopup();  // just comment this
      this._popup = popup;
      return this.addLayer(popup).fire('popupopen', {
        popup: this._popup
      });
    }
  });
 

  var mymap = L.map('mapid').setView([48.516604348867475, 14.501953125000002,], 4.96);

  //add open street map layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(mymap);

  //iterate through 6 factories
  for(let i = 1; i <= 4; i++)
  {
    oaJsApi.dpGet(["factory" + i + ".name", "factory" + i + ".amountAlarms",
      "factory" + i + ".coordinates.long", "factory" + i + ".coordinates.lat"], {
      success: function(data) {
        let name = data[0];
        let amountAlarms = data[1];
        let long = data[2];
        let lat = data[3];

        L.marker([long, lat]).addTo(mymap)
          .bindPopup('<strong>' + name + '</strong><br /><span id="factoryAlarms' + i + '">' + amountAlarms + '</span> Alarms')
          .openPopup();

        oaJsApi.dpConnect("factory" + i + ".amountAlarms", true, {
          success: function(data) {
            $("#factoryAlarms" + i).html(data.value[0]);
          }
        });
      }
    });

  }

</script>